# Deploy (ë°°í¬) ì›Œí¬í”Œë¡œìš°
# ì• í”Œë¦¬ì¼€ì´ì…˜ì„ í”„ë¡œë•ì…˜ í™˜ê²½ì— ë°°í¬í•˜ê³  ì„±ëŠ¥ì„ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤.
name: Deploy

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì¡°ê±´ ì„¤ì •
on:
  # main ë¸Œëžœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë  ë•Œ ì‹¤í–‰ (í”„ë¡œë•ì…˜ ë°°í¬)
  push:
    branches: [main]
  # GitHub UIì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

# ì›Œí¬í”Œë¡œìš° ìž‘ì—… ì •ì˜
jobs:
  # 1. í”„ë¦¬ë·° ë°°í¬ ìž‘ì—… (Pull Requestìš©)
  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    # Pull Request ì´ë²¤íŠ¸ì¼ ë•Œë§Œ ì‹¤í–‰
    if: github.event_name == 'pull_request'
    steps:
      # ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # pnpm íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì„¤ì •
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          # package.jsonì˜ packageManager í•„ë“œì™€ ì¼ì¹˜í•˜ëŠ” ë²„ì „ ì‚¬ìš©
          version: 9.0.0

      # Node.js ëŸ°íƒ€ìž„ í™˜ê²½ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # Node.js 18 ë²„ì „ ì‚¬ìš©
          node-version: 18
          # pnpm ì˜ì¡´ì„± ìºì‹± í™œì„±í™”
          cache: 'pnpm'

      # í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        # frozen-lockfile: pnpm-lock.yamlê³¼ ì •í™•ížˆ ì¼ì¹˜í•˜ëŠ” ë²„ì „ ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      # Docusaurus ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
      - name: Build Docusaurus
        # íŠ¹ì • íŒ¨í‚¤ì§€ë§Œ ë¹Œë“œí•˜ì—¬ ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•
        run: pnpm build --filter=docusaurus

  # 2. Lighthouse ì„±ëŠ¥ ê°ì‚¬ ìž‘ì—…
  lighthouse-audit:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    # í”„ë¦¬ë·° ë°°í¬ê°€ ì™„ë£Œëœ í›„ ì‹¤í–‰
    needs: [deploy-preview]
    # Pull Request ì´ë²¤íŠ¸ì¼ ë•Œë§Œ ì‹¤í–‰
    if: github.event_name == 'pull_request'
    steps:
      # ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # ë°°í¬ ì™„ë£Œê¹Œì§€ ëŒ€ê¸°
      - name: Wait for deployment
        # ë°°í¬ ì„œë²„ê°€ ì¤€ë¹„ë  ì‹œê°„ì„ í™•ë³´ (60ì´ˆ ëŒ€ê¸°)
        run: sleep 60

      # Lighthouse CIë¥¼ ì‚¬ìš©í•œ ì„±ëŠ¥ ê°ì‚¬
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          # Lighthouse ì„¤ì • íŒŒì¼ ê²½ë¡œ
          configPath: './.lighthouserc.json'
          # ê°ì‚¬ ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
          uploadArtifacts: true
          # ìž„ì‹œ ê³µê°œ ì €ìž¥ì†Œ ì‚¬ìš© (ê²°ê³¼ë¥¼ ê³µìœ  ê°€ëŠ¥í•œ URLë¡œ ì œê³µ)
          temporaryPublicStorage: true

  # 3. ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ìž‘ì—…
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    steps:
      # ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # Node.js ëŸ°íƒ€ìž„ í™˜ê²½ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # pnpm íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì„¤ì •
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      # í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Docusaurus ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
      - name: Build Docusaurus
        run: pnpm build --filter=docusaurus

      # ë²ˆë“¤ í¬ê¸° ë¶„ì„ ë° ë³´ê³ 
      - name: Analyze bundle sizes
        run: |
          # GitHub Actions ë‹¨ê³„ ìš”ì•½ì— ë²ˆë“¤ ë¶„ì„ ê²°ê³¼ ì¶”ê°€
          echo "## Bundle Analysis ðŸ“¦" >> $GITHUB_STEP_SUMMARY
          echo "| App | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|------|" >> $GITHUB_STEP_SUMMARY
          
          # Docusaurus ë¹Œë“œ ë””ë ‰í† ë¦¬ê°€ ì¡´ìž¬í•˜ëŠ” ê²½ìš° í¬ê¸° ì¸¡ì •
          if [ -d "apps/docusaurus/build" ]; then
            # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì„ ì‚¬ëžŒì´ ì½ê¸° ì‰¬ìš´ í˜•íƒœë¡œ í‘œì‹œ
            size=$(du -sh apps/docusaurus/build | cut -f1)
            echo "| docusaurus | $size |" >> $GITHUB_STEP_SUMMARY
          fi