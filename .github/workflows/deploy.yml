# Deploy (ë°°í¬) ì›Œí¬í”Œë¡œìš°
# ì• í”Œë¦¬ì¼€ì´ì…˜ì„ í”„ë¡œë•ì…˜ í™˜ê²½ì— ë°°í¬í•˜ê³  ì„±ëŠ¥ì„ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤.
name: Deploy

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì¡°ê±´ ì„¤ì •
on:
  # main ë¸Œëžœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë  ë•Œ ì‹¤í–‰ (í”„ë¡œë•ì…˜ ë°°í¬)
  push:
    branches: [main]
  # Pull Requestê°€ ìƒì„±ë˜ê±°ë‚˜ ì—…ë°ì´íŠ¸ë  ë•Œ ì‹¤í–‰ (í”„ë¦¬ë·° ë°°í¬)
  pull_request:
    branches: [main]
  # GitHub UIì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

# ì›Œí¬í”Œë¡œìš° ìž‘ì—… ì •ì˜
jobs:
  # 1. ë¹Œë“œ ê²€ì¦ ìž‘ì—… (Pull Requestìš©)
  build-verification:
    name: Build Verification
    runs-on: ubuntu-latest
    # Pull Request ì´ë²¤íŠ¸ì¼ ë•Œë§Œ ì‹¤í–‰
    if: github.event_name == 'pull_request'
    steps:
      # ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # pnpm íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì„¤ì •
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          # package.jsonì˜ packageManager í•„ë“œì™€ ì¼ì¹˜í•˜ëŠ” ë²„ì „ ì‚¬ìš©
          version: 9.0.0

      # Node.js ëŸ°íƒ€ìž„ í™˜ê²½ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # Node.js 18 ë²„ì „ ì‚¬ìš©
          node-version: 18
          # pnpm ì˜ì¡´ì„± ìºì‹± í™œì„±í™”
          cache: 'pnpm'

      # í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        # frozen-lockfile: pnpm-lock.yamlê³¼ ì •í™•ížˆ ì¼ì¹˜í•˜ëŠ” ë²„ì „ ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      # Docusaurus ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ê²€ì¦
      - name: Build Docusaurus
        # Vercel ìžë™ ë°°í¬ ì „ì— ë¹Œë“œê°€ ì„±ê³µí•˜ëŠ”ì§€ ê²€ì¦
        run: pnpm build --filter=docusaurus


  # 2. Lighthouse ì„±ëŠ¥ ê°ì‚¬ ìž‘ì—… (Vercel ìžë™ ë°°í¬ ê¸°ë°˜)
  lighthouse-audit:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    # PR ë˜ëŠ” main ë¸Œëžœì¹˜ í‘¸ì‹œ ì‹œ ì‹¤í–‰ (Vercelì´ ìžë™ ë°°í¬)
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    steps:
      # ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # Vercel ìžë™ ë°°í¬ ì™„ë£Œê¹Œì§€ ëŒ€ê¸°
      - name: Wait for Vercel deployment
        # Vercelì´ ìžë™ìœ¼ë¡œ ë°°í¬ë¥¼ ì™„ë£Œí•  ì‹œê°„ í™•ë³´ (120ì´ˆ ëŒ€ê¸°)
        run: sleep 120

      # Vercel í”„ë¦¬ë·° URL ìƒì„±
      - name: Generate Vercel preview URL
        id: get-url
        run: |
          # ì‹¤ì œ ë°°í¬ URLì„ ê¸°ë°˜ìœ¼ë¡œ í”„ë¦¬ë·° URL ìƒì„±
          # í”„ë¡œë•ì…˜: https://developjik-workspace-docusaurus.vercel.app/
          # í”„ë¦¬ë·°: https://developjik-workspace-docusaurus-git-{branch}.vercel.app/
          BRANCH_NAME=$(echo "${{ github.head_ref }}" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]')
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # PRì¼ ë•ŒëŠ” ë¸Œëžœì¹˜ë³„ í”„ë¦¬ë·° URL ì‚¬ìš©
            PREVIEW_URL="https://developjik-workspace-docusaurus-git-${BRANCH_NAME}.vercel.app"
          else
            # main ë¸Œëžœì¹˜ í‘¸ì‹œì¼ ë•ŒëŠ” í”„ë¡œë•ì…˜ URL ì‚¬ìš©
            PREVIEW_URL="https://developjik-workspace-docusaurus.vercel.app"
          fi
          
          echo "url=${PREVIEW_URL}" >> $GITHUB_OUTPUT
          echo "Generated URL: ${PREVIEW_URL}"

      # Lighthouse CIë¥¼ ì‚¬ìš©í•œ ì„±ëŠ¥ ê°ì‚¬
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          # Vercelì´ ìžë™ ë°°í¬í•œ URLì— ëŒ€í•´ Lighthouse ì‹¤í–‰
          urls: |
            ${{ steps.get-url.outputs.url }}
          # ê°ì‚¬ ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
          uploadArtifacts: true
          # ìž„ì‹œ ê³µê°œ ì €ìž¥ì†Œ ì‚¬ìš© (ê²°ê³¼ë¥¼ ê³µìœ  ê°€ëŠ¥í•œ URLë¡œ ì œê³µ)
          temporaryPublicStorage: true

  # 3. ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ìž‘ì—…
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    steps:
      # ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # Node.js ëŸ°íƒ€ìž„ í™˜ê²½ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # pnpm íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì„¤ì •
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      # í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Docusaurus ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
      - name: Build Docusaurus
        run: pnpm build --filter=docusaurus

      # ë²ˆë“¤ í¬ê¸° ë¶„ì„ ë° ë³´ê³ 
      - name: Analyze bundle sizes
        run: |
          # GitHub Actions ë‹¨ê³„ ìš”ì•½ì— ë²ˆë“¤ ë¶„ì„ ê²°ê³¼ ì¶”ê°€
          echo "## Bundle Analysis ðŸ“¦" >> $GITHUB_STEP_SUMMARY
          echo "| App | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|------|" >> $GITHUB_STEP_SUMMARY
          
          # Docusaurus ë¹Œë“œ ë””ë ‰í† ë¦¬ê°€ ì¡´ìž¬í•˜ëŠ” ê²½ìš° í¬ê¸° ì¸¡ì •
          if [ -d "apps/docusaurus/build" ]; then
            # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì„ ì‚¬ëžŒì´ ì½ê¸° ì‰¬ìš´ í˜•íƒœë¡œ í‘œì‹œ
            size=$(du -sh apps/docusaurus/build | cut -f1)
            echo "| docusaurus | $size |" >> $GITHUB_STEP_SUMMARY
          fi